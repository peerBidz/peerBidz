<% isPresent = CategoryMembers.where("category = ? and ipaddress = ?", params[:url], request.env['REMOTE_ADDR']) %>
<% if isPresent == nil %>
	<% CategoryMembers.create(:ipAddress => request.env['REMOTE_ADDR'], :category => params[:url])%>
<%end%>

<!-- pick IP addresses round robin style by oldest updated_at -->
<% db = CategoryMembers.where("category = ? and ipaddress <> ?", params[:url], request.env['REMOTE_ADDR']).order("updated_at asc") %>
<% myvar = CategoryMembers.new %>
<% if db != nil %>
	<% myvar = CategoryMembers.where("category = ? and ipaddress <> ?", params[:url], request.env['REMOTE_ADDR']).order("updated_at asc").first %>
	<% myvar.updated_at = DateTime.now  %>
	<% myvar.save %>
<% else %>

	<% myvar.ipadress = "0" %>	
<% end %>



<script type="text/javascript">
	window.parent.postMessage("<%= params[:url] %> <%= myvar.ipAddress %>", '*');
</script>
